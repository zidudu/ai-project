from openai import OpenAI
import streamlit as st
# from streamlit_google_oauth2 import GoogleOAuth2
import base64

# Google OAuth2 ì„¤ì •
client_id = "YOUR_GOOGLE_CLIENT_ID"
client_secret = "YOUR_GOOGLE_CLIENT_SECRET"
redirect_uri = "YOUR_REDIRECT_URI"

# OAuth2 ê°ì²´ ìƒì„±
#oauth2 = GoogleOAuth2(client_id, client_secret, redirect_uri)

st.set_page_config(page_title="ì¹œê·¼í•œ ì±—ë´‡", page_icon="ğŸ¤–")

# ë°°ê²½ ì´ë¯¸ì§€ í•¨ìˆ˜
def add_bg_from_local(image_file):
    with open(image_file, "rb") as image_file:
        encoded_string = base64.b64encode(image_file.read())
    st.markdown(
    f"""
    <style>
    .stApp {{
        background-image: url(data:image/{"png"};base64,{encoded_string.decode()});
        background-size: cover;
    }}
    </style>
    """,
    unsafe_allow_html=True
    )

# ë°°ê²½ ì´ë¯¸ì§€ ì¶”ê°€ (ë¡œì»¬ ì´ë¯¸ì§€ íŒŒì¼ ê²½ë¡œë¡œ ë³€ê²½í•˜ì„¸ìš”)
add_bg_from_local('C:/Users/COM/Desktop/cat.jpg')

st.markdown(
    """
    <style>
    .user-message {
        background-color: #e6f3ff;
        padding: 10px;
        border-radius: 15px;
        margin-bottom: 10px;
    }
    .bot-message {
        background-color: #f0f0f0;
        padding: 10px;
        border-radius: 15px;
        margin-bottom: 10px;
    }
    </style>
    """,
    unsafe_allow_html=True
)

st.title("ì¹œê·¼í•œ ì±—ë´‡")

client = OpenAI(api_key=st.secrets["OPENAI_API_KEY"])

if "openai_model" not in st.session_state:
    st.session_state["openai_model"] = "gpt-3.5-turbo"

system_message = '''
ë„ˆì˜ ì´ë¦„ì€ ë‚˜ì œ.
ë„ˆëŠ” í•­ìƒ ì¡´ëŒ“ë§ì„ í•˜ëŠ” ì±—ë´‡ì´ì•¼. ê·¸ë¦¬ê³  ì–¸ì œë‚˜ ì¹œê·¼í•˜ê²Œ ëŒ€ë‹µí•´ì¤˜. 
ì˜ì–´ë¡œ ì§ˆë¬¸ì„ ë°›ì•„ë„ ë¬´ì¡°ê±´ í•œê¸€ë¡œ ë‹µë³€í•´ì¤˜.
í•œê¸€ì´ ì•„ë‹Œ ë‹µë³€ì¼ ë•Œ ë‹¤ì‹œ ìƒê°í•´ì„œ ê¼­ í•œê¸€ë¡œ ë§Œë“¤ì–´ì¤˜
ëª¨ë“  ë‹µë³€ ëì—ëŠ” ë‹µë³€ì— ë§ëŠ” ì´ëª¨í‹°ì½˜ë„ ì¶”ê°€í•´ì¤˜.
ê·¸ë¦¬ê³  ì–¸ì œë‚˜ ì§ˆë¬¸ë„ í•˜ë‚˜ì”© í•´ì¤˜. ì§ˆë¬¸í• ë•Œë„ ì¡´ëŒ“ë§ë¡œ ë§í•´ì¤˜
'''

if "messages" not in st.session_state:
    st.session_state.messages = []
    st.session_state.messages = [{"role": "user", "content": system_message}]

for message in st.session_state.messages[1:]:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

if prompt := st.chat_input("ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?"):
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.markdown(f'<div class="user-message">{prompt}</div>', unsafe_allow_html=True)

    with st.chat_message("assistant"):
        with st.spinner("ë‚˜ì œê°€ ìƒê° ì¤‘ì…ë‹ˆë‹¤..."):
            stream = client.chat.completions.create(
                model=st.session_state["openai_model"],
                messages=[
                    {"role": m["role"], "content": m["content"]}
                    for m in st.session_state.messages
                ],
                temperature=st.session_state.get("temperature", 1.0),
                top_p=st.session_state.get("top_p", 0.1),
                stream=True,
            )
            response = st.write_stream(stream)
        st.markdown(f'<div class="bot-message">{response}</div>', unsafe_allow_html=True)
    st.session_state.messages.append({"role": "assistant", "content": response})

with st.sidebar:
    st.title("ì„¤ì •")
    st.session_state["openai_model"] = st.selectbox("ëª¨ë¸ ì„ íƒ", ["gpt-3.5-turbo", "gpt-4"])
    st.session_state["temperature"] = st.slider("ì°½ì˜ì„± ì¡°ì ˆ", 0.0, 1.0, 1.0)
    st.session_state["top_p"] = st.slider("ë‹¤ì–‘ì„± ì¡°ì ˆ", 0.0, 1.0, 0.1)

    if st.button("ëŒ€í™” ë‚´ìš© ë‹¤ìš´ë¡œë“œ"):
        chat_content = "\n".join([f"{m['role']}: {m['content']}" for m in st.session_state.messages[1:]])
        st.download_button("ëŒ€í™” ë‚´ìš© ë‹¤ìš´ë¡œë“œ", chat_content, "chat_history.txt")
    
#     # êµ¬ê¸€ ë¡œê·¸ì¸ ë²„íŠ¼
#     login_info = oauth2.login(
#         button_text="êµ¬ê¸€ë¡œ ë¡œê·¸ì¸",
#         logout_button_text="ë¡œê·¸ì•„ì›ƒ"
#     )

#     if login_info:
#         st.write(f"ì•ˆë…•í•˜ì„¸ìš”, {login_info['name']}ë‹˜!")
#         st.write(f"ì´ë©”ì¼: {login_info['email']}")
#     else:
#         st.write("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.")

# # ë©”ì¸ ì˜ì—­ì— ë¡œê·¸ì¸ ìƒíƒœ í‘œì‹œ
# if login_info:
#     st.sidebar.success(f"{login_info['name']}ë‹˜ìœ¼ë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.")
# else:
#     st.sidebar.warning("ë¡œê·¸ì¸ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
