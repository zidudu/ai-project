import streamlit as st
from google_auth_oauthlib.flow import Flow
from google.oauth2 import id_token
from google.auth.transport import requests
import base64

# ë¹„ë°€ ë³€ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸°
client_id = st.secrets["google_oauth"]["client_id"]
client_secret = st.secrets["google_oauth"]["client_secret"]
redirect_uri = st.secrets["google_oauth"]["redirect_uri"]

# OAuth2 Flow ì„¤ì •
flow = Flow.from_client_config(
    {
        "web": {
            "client_id": client_id,
            "client_secret": client_secret,
            "auth_uri": "https://accounts.google.com/o/oauth2/auth",
            "token_uri": "https://oauth2.googleapis.com/token",
        }
    },
    scopes=["openid", "https://www.googleapis.com/auth/userinfo.email", "https://www.googleapis.com/auth/userinfo.profile"],
    redirect_uri=redirect_uri
)

st.set_page_config(page_title="ì¹œê·¼í•œ ì±—ë´‡", page_icon="ğŸ¤–")

# ë°°ê²½ ì´ë¯¸ì§€ í•¨ìˆ˜
def add_bg_from_local(image_file):
    with open(image_file, "rb") as image_file:
        encoded_string = base64.b64encode(image_file.read())
    st.markdown(
    f"""
    <style>
    .stApp {{
        background-image: url(data:image/{"png"};base64,{encoded_string.decode()});
        background-size: cover;
    }}
    </style>
    """,
    unsafe_allow_html=True
    )

# ë°°ê²½ ì´ë¯¸ì§€ ì¶”ê°€ (ë¡œì»¬ ì´ë¯¸ì§€ íŒŒì¼ ê²½ë¡œë¡œ ë³€ê²½í•˜ì„¸ìš”)
add_bg_from_local('C:/Users/COM/Desktop/cat.jpg')
# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
if "user_info" not in st.session_state:
    st.session_state.user_info = None

# ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
def is_logged_in():
    return st.session_state.user_info is not None

# ë¡œê·¸ì¸ í•¨ìˆ˜
def login():
    authorization_url, _ = flow.authorization_url(prompt="consent")
    st.markdown(f"[Googleë¡œ ë¡œê·¸ì¸](javascript:window.open('{authorization_url}','_blank','width=500,height=600'))")

# ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
def logout():
    st.session_state.user_info = None
    st.experimental_rerun()

# ì½œë°± ì²˜ë¦¬
def handle_callback():
    if "code" in st.experimental_get_query_params():
        code = st.experimental_get_query_params()["code"][0]
        flow.fetch_token(code=code)
        credentials = flow.credentials
        token_info = id_token.verify_oauth2_token(
            credentials.id_token, requests.Request(), client_id
        )
        st.session_state.user_info = token_info
        st.experimental_set_query_params()
        st.experimental_rerun()

# ì½œë°± ì²˜ë¦¬
handle_callback()

# ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ UI
st.title("ì¹œê·¼í•œ ì±—ë´‡")

# ì‚¬ì´ë“œë°”
with st.sidebar:
    st.title("ì„¤ì •")
    
    if is_logged_in():
        st.write(f"ì•ˆë…•í•˜ì„¸ìš”, {st.session_state.user_info['name']}ë‹˜!")
        st.write(f"ì´ë©”ì¼: {st.session_state.user_info['email']}")
        if st.button("ë¡œê·¸ì•„ì›ƒ"):
            logout()
    else:
        login()

    # ì—¬ê¸°ì— ë‹¤ë¥¸ ì‚¬ì´ë“œë°” ì„¤ì •ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

# ì±—ë´‡ ë¡œì§
if is_logged_in():
    # ì—¬ê¸°ì— ì±—ë´‡ ëŒ€í™” ë¡œì§ì„ êµ¬í˜„í•©ë‹ˆë‹¤.
    st.write("ì±—ë´‡ê³¼ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”.")
else:
    st.write("ë¡œê·¸ì¸ í›„ ì±—ë´‡ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")

# ì¶”ê°€ì ì¸ UI ìš”ì†Œë‚˜ ê¸°ëŠ¥ì„ ì—¬ê¸°ì— êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
